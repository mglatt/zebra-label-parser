# Example Home Assistant Automations for Zebra Label Printer
#
# Copy the automations you want into your HA automations.yaml or
# create them via the HA UI (Settings → Automations & Scenes → Create).

# ──────────────────────────────────────────────────────────────────
# 1. PHONE SHARE → PRINT (via iOS Shortcut + HA Webhook)
#
# Print a shipping label by sharing a PDF or image from your iPhone.
# Uses an iOS Shortcut to base64-encode the file and POST it to a
# Home Assistant webhook, which triggers this automation.
#
# Setup — create a Shortcut on your iPhone (one-time):
#   1. Open the Shortcuts app
#   2. Tap "+" to create a new shortcut, name it "Print Label"
#   3. Tap the (i) button at the bottom → enable "Show in Share Sheet"
#   4. Tap "Share Sheet Input" → select "PDFs" and "Images"
#   5. Add action: "Base64 Encode" (input: Shortcut Input)
#   6. Add action: "URL" → enter your HA webhook URL:
#        https://<your-ha-url>/api/webhook/zebra_print_label
#      (Use your Nabu Casa URL, e.g. https://xxxx.ui.nabu.casa,
#       or local: http://homeassistant.local:8123)
#   7. Add action: "Get Contents of URL"
#        - Method: POST
#        - Headers: Content-Type = application/json
#        - Request Body: JSON
#          file_base64  = (select "Base64 Encoded" variable)
#          filename     = (select "Shortcut Input" → Name)
#   8. Save the shortcut
#
# Usage:
#   - From any app (Mail, Safari, Files, etc.), tap the Share button
#   - Select "Print Label" from the share sheet
#   - The label prints automatically
#
# Security note:
#   The webhook_id acts as a bearer token — anyone who knows the URL
#   can trigger a print. For better security, replace "zebra_print_label"
#   with a random string (e.g., "zebra_abc123xyz789") in both this
#   automation and the Shortcut URL.
# ──────────────────────────────────────────────────────────────────

- alias: "Print label shared from phone"
  description: "Prints a label when shared via iOS Shortcut to the HA webhook"
  triggers:
    - trigger: webhook
      webhook_id: zebra_print_label
      local_only: false
  actions:
    - action: rest_command.zebra_print_label_base64
      data:
        file_base64: "{{ trigger.json.file_base64 }}"
        filename: "{{ trigger.json.filename | default('shared-label.pdf') }}"

# Add this to your configuration.yaml for the above automation:
#
# rest_command:
#   zebra_print_label_base64:
#     url: "http://localhost:8099/api/labels/webhook"
#     method: POST
#     content_type: "application/json"
#     payload: '{"file_base64": "{{ file_base64 }}", "filename": "{{ filename }}"}'

# ──────────────────────────────────────────────────────────────────
# 2. FOLDER WATCHER → AUTO-PRINT
#
# Watches a folder for new PDF files and auto-prints them.
# Great with a network share — users just drop files in a folder.
#
# Setup:
#   1. Add to configuration.yaml:
#
#      homeassistant:
#        allowlist_external_dirs:
#          - "/share/shipping_labels"
#
#      folder_watcher:
#        - folder: "/share/shipping_labels"
#          patterns:
#            - "*.pdf"
#            - "*.png"
#            - "*.jpg"
#
#      rest_command:
#        zebra_print_label:
#          url: "http://localhost:8099/api/labels/webhook"
#          method: POST
#          content_type: "application/json"
#          payload: '{"file_path": "{{ file_path }}"}'
#
#   2. Mount a network share to /share/shipping_labels (via Samba addon)
#   3. Restart HA
# ──────────────────────────────────────────────────────────────────

- alias: "Auto-print shipping labels from watched folder"
  description: "Prints labels automatically when dropped into the shipping_labels folder"
  triggers:
    - trigger: event
      event_type: folder_watcher
      event_data:
        event_type: created
  conditions:
    - condition: template
      value_template: >
        {{ trigger.event.data.path.endswith('.pdf')
           or trigger.event.data.path.endswith('.png')
           or trigger.event.data.path.endswith('.jpg') }}
  actions:
    - action: rest_command.zebra_print_label
      data:
        file_path: "{{ trigger.event.data.path }}"
    # Optional: send a notification when the label is printed
    - action: notify.notify
      data:
        title: "Label Printed"
        message: "Printed shipping label: {{ trigger.event.data.path | basename }}"

# ──────────────────────────────────────────────────────────────────
# 3. DASHBOARD BUTTON → OPEN LABEL PRINTER
#
# Not an automation — just a Lovelace card config.
# Add this to your dashboard YAML:
#
#   type: button
#   name: Print Label
#   icon: mdi:printer
#   tap_action:
#     action: navigate
#     navigation_path: /hassio/ingress/zebra-label-printer
#
# Or use the addon-iframe card (install from HACS):
#
#   type: custom:addon-iframe
#   addon: zebra-label-printer
# ──────────────────────────────────────────────────────────────────
